---
description: 
globs: 
alwaysApply: false
---
# ValeTTS - Diretrizes e PadrÃµes do Projeto
*Regras e Guidelines para Desenvolvimento Consistente*

## ðŸŽ¯ Filosofia do Projeto

### PrincÃ­pios Fundamentais
1. **Qualidade sobre Velocidade**: Priorizamos cÃ³digo robusto e testado
2. **Modularidade**: Componentes independentes e reutilizÃ¡veis
3. **Performance-First**: OtimizaÃ§Ã£o contÃ­nua para produÃ§Ã£o
4. **DocumentaÃ§Ã£o Viva**: CÃ³digo auto-documentado e docs atualizadas
5. **Reprodutibilidade**: Resultados consistentes e versionamento rigoroso

---

## ðŸ—ï¸ Arquitetura e EstruturaÃ§Ã£o

### Estrutura de DiretÃ³rios (OBRIGATÃ“RIA)
```
ValeTTS/
â”œâ”€â”€ README.md                    # DocumentaÃ§Ã£o principal
â”œâ”€â”€ CHANGELOG.md                 # Log de mudanÃ§as
â”œâ”€â”€ LICENSE                      # Licenciamento
â”œâ”€â”€ requirements.txt             # Dependencies Python
â”œâ”€â”€ requirements-dev.txt         # Dependencies de desenvolvimento
â”œâ”€â”€ setup.py                     # InstalaÃ§Ã£o do pacote
â”œâ”€â”€ pyproject.toml              # ConfiguraÃ§Ãµes do projeto
â”œâ”€â”€ .gitignore                  # ExclusÃµes Git
â”œâ”€â”€ .pre-commit-config.yaml     # Hooks de pre-commit
â”œâ”€â”€ docker/                     # Containers Docker
â”‚   â”œâ”€â”€ Dockerfile.dev
â”‚   â”œâ”€â”€ Dockerfile.prod
â”‚   â””â”€â”€ docker-compose.yml
â”œâ”€â”€ configs/                    # ConfiguraÃ§Ãµes YAML/JSON
â”‚   â”œâ”€â”€ models/                 # Configs de modelos
â”‚   â”œâ”€â”€ training/               # Configs de treinamento
â”‚   â””â”€â”€ deployment/             # Configs de deployment
â”œâ”€â”€ valetts/                    # CÃ³digo fonte principal
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ models/                 # Arquiteturas de modelos
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ base/               # Modelos base
â”‚   â”‚   â”œâ”€â”€ vits2/              # ImplementaÃ§Ã£o VITS2
â”‚   â”‚   â”œâ”€â”€ meta_learning/      # MAML e few-shot
â”‚   â”‚   â”œâ”€â”€ prosody/            # Controle prosÃ³dico
â”‚   â”‚   â””â”€â”€ vocoders/           # BigVGAN-v2 e outros
â”‚   â”œâ”€â”€ data/                   # Pipeline de dados
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ preprocessing/      # Preprocessamento
â”‚   â”‚   â”œâ”€â”€ loaders/           # Data loaders
â”‚   â”‚   â””â”€â”€ augmentation/      # Data augmentation
â”‚   â”œâ”€â”€ training/              # Sistema de treinamento
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ trainers/          # Trainers especÃ­ficos
â”‚   â”‚   â”œâ”€â”€ optimizers/        # Otimizadores customizados
â”‚   â”‚   â””â”€â”€ schedulers/        # Learning rate schedulers
â”‚   â”œâ”€â”€ inference/             # Sistema de inferÃªncia
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ synthesizers/      # Engines de sÃ­ntese
â”‚   â”‚   â”œâ”€â”€ voice_cloning/     # Few-shot cloning
â”‚   â”‚   â””â”€â”€ api/               # APIs de inferÃªncia
â”‚   â”œâ”€â”€ evaluation/            # MÃ©tricas e avaliaÃ§Ã£o
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ metrics/           # MÃ©tricas automatizadas
â”‚   â”‚   â””â”€â”€ benchmarks/        # Benchmarking tools
â”‚   â””â”€â”€ utils/                 # UtilitÃ¡rios gerais
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ audio.py           # Processamento de Ã¡udio
â”‚       â”œâ”€â”€ text.py            # Processamento de texto
â”‚       â”œâ”€â”€ io.py              # I/O operations
â”‚       â””â”€â”€ visualization.py   # Plotting e visualizaÃ§Ã£o
â”œâ”€â”€ scripts/                   # Scripts de uso
â”‚   â”œâ”€â”€ train.py               # Script de treinamento
â”‚   â”œâ”€â”€ inference.py           # Script de inferÃªncia
â”‚   â”œâ”€â”€ evaluate.py            # Script de avaliaÃ§Ã£o
â”‚   â””â”€â”€ deployment/            # Scripts de deployment
â”œâ”€â”€ tests/                     # Testes automatizados
â”‚   â”œâ”€â”€ unit/                  # Testes unitÃ¡rios
â”‚   â”œâ”€â”€ integration/           # Testes de integraÃ§Ã£o
â”‚   â”œâ”€â”€ performance/           # Testes de performance
â”‚   â””â”€â”€ fixtures/              # Dados de teste
â”œâ”€â”€ docs/                      # DocumentaÃ§Ã£o
â”‚   â”œâ”€â”€ source/                # Sphinx source
â”‚   â”œâ”€â”€ api/                   # API documentation
â”‚   â””â”€â”€ tutorials/             # Tutoriais e exemplos
â”œâ”€â”€ examples/                  # Exemplos de uso
â”‚   â”œâ”€â”€ basic_synthesis/
â”‚   â”œâ”€â”€ voice_cloning/
â”‚   â””â”€â”€ multilingual/
â””â”€â”€ data/                      # Dados locais (nÃ£o versionados)
    â”œâ”€â”€ raw/                   # Dados brutos
    â”œâ”€â”€ processed/             # Dados processados
    â””â”€â”€ models/                # Modelos treinados
```

---

## ðŸ’» PadrÃµes de CÃ³digo

### Linguagem e VersÃµes
- **Python**: 3.10-3.12 (obrigatÃ³rio para compatibilidade PyTorch e features modernas)
- **PyTorch**: 2.0+ (para performance otimizada)
- **CUDA**: 11.8+ (para aceleraÃ§Ã£o GPU)
- **Package Manager**: `uv` (recomendado) ou `pip` (fallback)

### Style Guide (OBRIGATÃ“RIO)
```bash
# FormataÃ§Ã£o automÃ¡tica
black --line-length 88 --target-version py310

# Linting
flake8 --max-line-length=88 --extend-ignore=E203,W503

# Type checking
mypy --strict --ignore-missing-imports

# Package management (recomendado)
uv add torch>=2.0.0  # mais rÃ¡pido que pip
uv sync              # resolve conflitos automaticamente
```

### ConvenÃ§Ãµes de Nomenclatura
```python
# Classes: PascalCase
class VoiceCloner:
    pass

# FunÃ§Ãµes e variÃ¡veis: snake_case
def train_model():
    learning_rate = 1e-4

# Constantes: UPPER_SNAKE_CASE
MAX_SEQUENCE_LENGTH = 1024
DEFAULT_SAMPLE_RATE = 22050

# Arquivos: snake_case.py
# voice_cloning.py, meta_learning.py

# DiretÃ³rios: snake_case
# data_loaders/, model_architectures/
```

### DocumentaÃ§Ã£o de CÃ³digo (OBRIGATÃ“RIA)
```python
def synthesize_speech(
    text: str,
    speaker_id: Optional[str] = None,
    language: str = "en",
    prosody_controls: Optional[Dict[str, float]] = None
) -> torch.Tensor:
    """Sintetiza fala a partir de texto usando o modelo TTS.
    
    Args:
        text: Texto a ser sintetizado
        speaker_id: ID do speaker (None para speaker padrÃ£o)
        language: CÃ³digo do idioma (ISO 639-1)
        prosody_controls: Controles prosÃ³dicos opcionais
            - pitch_scale: Escala de pitch (0.5-2.0)
            - speed_scale: Escala de velocidade (0.5-2.0)
            - energy_scale: Escala de energia (0.5-2.0)
    
    Returns:
        Tensor de Ã¡udio sintetizado (shape: [1, T])
        
    Raises:
        ValueError: Se texto vazio ou idioma nÃ£o suportado
        RuntimeError: Se erro durante sÃ­ntese
        
    Example:
        >>> synthesizer = TTSSynthesizer()
        >>> audio = synthesizer.synthesize_speech(
        ...     "Hello world", 
        ...     language="en",
        ...     prosody_controls={"pitch_scale": 1.2}
        ... )
        >>> audio.shape
        torch.Size([1, 44100])
    """
```

---

## ðŸ§ª Testes e Qualidade

### EstratÃ©gia de Testes (OBRIGATÃ“RIA)
```python
# Estrutura de testes
tests/
â”œâ”€â”€ unit/                      # Testes unitÃ¡rios (>80% coverage)
â”‚   â”œâ”€â”€ test_models.py
â”‚   â”œâ”€â”€ test_data_processing.py
â”‚   â””â”€â”€ test_utils.py
â”œâ”€â”€ integration/               # Testes de integraÃ§Ã£o
â”‚   â”œâ”€â”€ test_training_pipeline.py
â”‚   â”œâ”€â”€ test_inference_pipeline.py
â”‚   â””â”€â”€ test_api_endpoints.py
â”œâ”€â”€ performance/               # Testes de performance
â”‚   â”œâ”€â”€ test_rtf_benchmarks.py
â”‚   â”œâ”€â”€ test_memory_usage.py
â”‚   â””â”€â”€ test_quality_metrics.py
â””â”€â”€ fixtures/                  # Dados de teste
    â”œâ”€â”€ audio_samples/
    â”œâ”€â”€ text_samples/
    â””â”€â”€ model_configs/
```

### MÃ©tricas de Qualidade MÃ­nimas
- **Cobertura de CÃ³digo**: â‰¥80%
- **Testes UnitÃ¡rios**: Todos os mÃ³dulos principais
- **Testes de IntegraÃ§Ã£o**: Pipelines end-to-end
- **Performance Tests**: RTF, MemÃ³ria, Qualidade

### CI/CD Pipeline
```yaml
# .github/workflows/ci.yml
name: CI/CD Pipeline
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh
      - name: Install dependencies
        run: |
          uv sync --extra dev
          source .venv/bin/activate
      - name: Run linting
        run: |
          black --check .
          flake8 .
          mypy valetts/
      - name: Run tests
        run: pytest --cov=valetts --cov-report=xml
      - name: Upload coverage
        uses: codecov/codecov-action@v3
```

---

## ðŸ”§ Tecnologias e Dependencies

### Core Stack (OBRIGATÃ“RIO)
```toml
# pyproject.toml (recomendado com uv)
[project]
name = "valetts"
version = "0.1.0"
description = "Sistema TTS de Ãšltima GeraÃ§Ã£o"
requires-python = ">=3.10,<3.13"
dependencies = [
    "torch>=2.0.0",
    "torchaudio>=2.0.0", 
    "pytorch-lightning>=2.0.0",
    "librosa>=0.10.0",
    "soundfile>=0.12.0",
    "numpy>=1.21.0",
    "scipy>=1.9.0",
    "matplotlib>=3.5.0",
    "tensorboard>=2.10.0",
    "wandb>=0.13.0",
    "hydra-core>=1.2.0",
    "omegaconf>=2.2.0",
]

# Ou requirements.txt (fallback)
# torch>=2.0.0
# torchaudio>=2.0.0
# pytorch-lightning>=2.0.0
# librosa>=0.10.0
# soundfile>=0.12.0
# numpy>=1.21.0
# scipy>=1.9.0
# matplotlib>=3.5.0
# tensorboard>=2.10.0
# wandb>=0.13.0
# hydra-core>=1.2.0
# omegaconf>=2.2.0
```

### Development Tools (OBRIGATÃ“RIO)
```toml
# Em pyproject.toml
[project.optional-dependencies]
dev = [
    "pytest>=7.0.0",
    "pytest-cov>=4.0.0", 
    "black>=22.0.0",
    "flake8>=5.0.0",
    "mypy>=0.991",
    "pre-commit>=2.20.0",
    "sphinx>=5.0.0",
    "sphinx-rtd-theme>=1.0.0",
    "jupyter>=1.0.0",
    "ipywidgets>=8.0.0",
]

# InstalaÃ§Ã£o com uv:
# uv sync --extra dev
```

### Performance & Deployment
```txt
# Opcional para produÃ§Ã£o
onnx>=1.12.0
onnxruntime-gpu>=1.12.0
tensorrt>=8.5.0
triton>=2.0.0
uvicorn>=0.18.0  # para API FastAPI
gunicorn>=20.1.0  # para deployment
redis>=4.3.0      # para cache
```

---

## ðŸ“Š ConfiguraÃ§Ãµes e HyperparÃ¢metros

### Sistema de ConfiguraÃ§Ã£o (Hydra + OmegaConf)
```yaml
# configs/model/vits2_base.yaml
_target_: valetts.models.vits2.VITS2

# Architecture
hidden_channels: 192
filter_channels: 768
n_heads: 2
n_layers: 6
kernel_size: 3
p_dropout: 0.1

# Training
learning_rate: 2e-4
adam_b1: 0.8
adam_b2: 0.99
lr_decay: 0.999875
init_lr_ratio: 1.0
warmup_epochs: 0
c_mel: 45
c_kl: 1.0

# Audio
sampling_rate: 22050
hop_length: 256
win_length: 1024
n_mel_channels: 80
mel_fmin: 0.0
mel_fmax: null

# Multilingual
num_languages: 8
language_embedding_dim: 16
```

### ConvenÃ§Ãµes de ConfiguraÃ§Ã£o
- **Arquivos YAML**: Para configuraÃ§Ãµes legÃ­veis
- **Hydra decorators**: Para gestÃ£o de configuraÃ§Ãµes
- **Environment variables**: Para secrets e deployment
- **Validation**: Pydantic models para validaÃ§Ã£o

### Gerenciamento de DependÃªncias com UV
```bash
# InstalaÃ§Ã£o do uv (uma vez)
curl -LsSf https://astral.sh/uv/install.sh | sh

# CriaÃ§Ã£o de projeto
uv init valetts
cd valetts

# Adicionar dependÃªncias
uv add torch>=2.0.0 torchaudio>=2.0.0
uv add --dev pytest>=7.0.0 black>=22.0.0

# Sincronizar ambiente
uv sync                 # instala todas as deps
uv sync --extra dev     # inclui deps de desenvolvimento

# Executar comandos no ambiente
uv run python train.py
uv run pytest
uv run black .

# BenefÃ­cios do uv:
# - 10-100x mais rÃ¡pido que pip
# - Resolve conflitos automaticamente  
# - Cache global inteligente
# - Lock file automÃ¡tico (uv.lock)
# - Virtual env automÃ¡tico
```

---

## ðŸš€ Performance e OtimizaÃ§Ã£o

### Benchmarks MÃ­nimos (OBRIGATÃ“RIOS)
```python
# MÃ©tricas de Performance Requeridas
PERFORMANCE_REQUIREMENTS = {
    "rtf_gpu_a100": 0.004,      # RTF â‰¤0.004 em A100
    "rtf_gpu_v100": 0.010,      # RTF â‰¤0.010 em V100  
    "rtf_cpu": 0.500,           # RTF â‰¤0.500 em CPU
    "vram_usage_gb": 8,         # VRAM â‰¤8GB
    "ram_usage_gb": 16,         # RAM â‰¤16GB
    "latency_ms": 500,          # LatÃªncia â‰¤500ms
    "throughput_concurrent": 10  # â‰¥10 sÃ­nteses simultÃ¢neas
}

# MÃ©tricas de Qualidade Requeridas
QUALITY_REQUIREMENTS = {
    "mos_score": 4.2,           # MOS â‰¥4.2
    "speaker_similarity": 0.73, # Similaridade â‰¥73%
    "pesq_score": 4.0,          # PESQ â‰¥4.0
    "mcd_score": 0.30,          # MCD â‰¤0.30
    "stoi_score": 0.85,         # STOI â‰¥0.85
}
```

### OtimizaÃ§Ãµes ObrigatÃ³rias
1. **Mixed Precision**: PyTorch AMP para speedup 2-3x
2. **Gradient Checkpointing**: ReduÃ§Ã£o 50-80% uso de memÃ³ria
3. **Compilation**: torch.compile para PyTorch 2.0+
4. **Distributed Training**: Multi-GPU com DeepSpeed
5. **Model Quantization**: Para deployment eficiente

---

## ðŸ“š DocumentaÃ§Ã£o

### DocumentaÃ§Ã£o ObrigatÃ³ria
1. **README.md**: Overview, instalaÃ§Ã£o, uso bÃ¡sico
2. **API Documentation**: Docstrings + Sphinx autodoc
3. **Tutorials**: Jupyter notebooks com exemplos
4. **Architecture Guide**: Diagramas e explicaÃ§Ãµes tÃ©cnicas
5. **Deployment Guide**: InstruÃ§Ãµes de produÃ§Ã£o

### Formato de DocumentaÃ§Ã£o
```python
# Sphinx configuration
extensions = [
    'sphinx.ext.autodoc',
    'sphinx.ext.viewcode',
    'sphinx.ext.napoleon',
    'sphinx.ext.mathjax',
    'myst_parser',
]

# Napoleon settings for Google-style docstrings
napoleon_google_docstring = True
napoleon_numpy_docstring = False
napoleon_include_init_with_doc = False
napoleon_include_private_with_doc = False
```

---

## ðŸ” SeguranÃ§a e Privacidade

### PrÃ¡ticas de SeguranÃ§a
1. **Secrets Management**: Nunca commitar API keys/tokens
2. **Input Validation**: SanitizaÃ§Ã£o rigorosa de inputs
3. **Rate Limiting**: Para APIs pÃºblicas
4. **Logging Seguro**: NÃ£o logar dados sensÃ­veis
5. **Dependencies**: Auditoria regular de vulnerabilidades

### ProteÃ§Ã£o de Dados
- **Audio Data**: AnonimizaÃ§Ã£o quando possÃ­vel
- **Model Weights**: Versionamento seguro
- **User Data**: Compliance com LGPD/GDPR
- **Telemetry**: Opt-in para coleta de mÃ©tricas

---

## ðŸŒ Versionamento e Release

### Semantic Versioning (OBRIGATÃ“RIO)
```
MAJOR.MINOR.PATCH
1.0.0 - Release inicial
1.1.0 - Novas features
1.1.1 - Bug fixes
2.0.0 - Breaking changes
```

### Git Workflow
```bash
# Branch naming
feature/nome-da-feature
bugfix/nome-do-bug
hotfix/nome-do-hotfix
release/v1.2.0

# Commit messages (Conventional Commits)
feat: add voice cloning functionality
fix: resolve memory leak in inference
docs: update API documentation
test: add unit tests for VITS2 model
```

### Release Process
1. **Feature freeze** na branch develop
2. **Testing intensivo** em branch release
3. **Tag versioning** na branch main
4. **Deployment automatizado** via CI/CD
5. **Documentation update** pÃ³s-release

---

## ðŸƒâ€â™‚ï¸ Workflow de Desenvolvimento

### Daily Workflow
1. **Pull latest**: `git pull origin main`
2. **Create branch**: `git checkout -b feature/my-feature`
3. **Run tests**: `pytest` antes de commitar
4. **Pre-commit hooks**: AutomÃ¡tico com `pre-commit install`
5. **Push & PR**: Code review obrigatÃ³rio

### Code Review Guidelines
- **Mandatory reviews**: MÃ­nimo 1 reviewer
- **Automated checks**: CI deve passar
- **Documentation**: Updates necessÃ¡rias incluÃ­das
- **Performance**: Benchmarks nÃ£o regressivos
- **Tests**: Cobertura mantida/melhorada

---

## âš¡ Performance Monitoring

### MÃ©tricas ContÃ­nuas
```python
# Logging de mÃ©tricas obrigatÃ³rio
import wandb
import tensorboard

# Durante treinamento
wandb.log({
    "train/loss": loss.item(),
    "train/rtf": rtf_score,
    "train/memory_usage": torch.cuda.memory_allocated(),
    "val/mos_score": mos_prediction,
    "val/speaker_similarity": speaker_sim,
})

# Durante inferÃªncia
metrics = {
    "inference_time_ms": inference_time * 1000,
    "gpu_utilization": gpu_util_percent,
    "memory_peak_mb": memory_peak / 1024**2,
    "audio_quality_score": quality_score,
}
```

### Alertas AutomÃ¡ticos
- **Performance degradation**: RTF > threshold
- **Quality regression**: MOS drop > 0.1
- **Memory leaks**: Crescimento contÃ­nuo de memÃ³ria
- **Error rates**: Taxa de erro > 1%

---

## ðŸŽ¨ UI/UX Guidelines

### Demo Interface Requirements
1. **Responsiva**: Mobile-first design
2. **AcessÃ­vel**: WCAG 2.1 AA compliance
3. **Performance**: Load time <3s
4. **Real-time**: Feedback durante sÃ­ntese
5. **Multi-idioma**: Interface localizada

### API Design Principles
```python
# RESTful endpoints consistentes
POST /api/v1/synthesize
POST /api/v1/clone-voice
GET  /api/v1/voices
GET  /api/v1/languages
GET  /api/v1/health

# Response format padronizado
{
    "success": true,
    "data": {...},
    "metadata": {
        "request_id": "uuid",
        "processing_time_ms": 234,
        "model_version": "1.2.0"
    },
    "error": null
}
```

---

## ðŸ“‹ Checklist de Compliance

### Antes de cada Release
- [ ] Todos os testes passando (100%)
- [ ] Cobertura de cÃ³digo â‰¥80%
- [ ] DocumentaÃ§Ã£o atualizada
- [ ] Performance benchmarks validados
- [ ] Security audit realizada
- [ ] Breaking changes documentadas
- [ ] Migration guide criado (se necessÃ¡rio)
- [ ] Demo funcional atualizado

### RevisÃ£o Mensal
- [ ] Dependencies atualizadas
- [ ] Security vulnerabilities verificadas
- [ ] Performance metrics analisadas
- [ ] User feedback incorporado
- [ ] Roadmap atualizado

---

**Esta documentaÃ§Ã£o Ã© viva e deve ser atualizada conforme o projeto evolui. Todas as diretrizes sÃ£o obrigatÃ³rias a menos que explicitamente marcadas como opcionais.**

**Ãšltima atualizaÃ§Ã£o**: Janeiro 2025  
**VersÃ£o das diretrizes**: 1.0.0  
**ResponsÃ¡vel**: Equipe ValeTTS 